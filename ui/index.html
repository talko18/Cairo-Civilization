<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cairo Civ</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#1a1a2e;--bg2:#16213e;--panel:#0f3460;--accent:#e94560;--accent2:#c73a52;
--gold:#f5c542;--text:#e0e0e0;--dim:#8899aa;--border:#2a3a5e;
--food:#66bb6a;--prod:#ff9800;--sci:#4fc3f7;--rad:6px;
--p0:#3498db;--p0bg:rgba(52,152,219,.18);--p0txt:#5dade2;
--p1:#e74c3c;--p1bg:rgba(231,76,60,.18);--p1txt:#ec7063}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--rad);transition:background .15s}

/* ── Setup overlay ── */
#setup{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px}
#setup h1{font-size:2.4rem;color:var(--gold);letter-spacing:2px}
#setup p{color:var(--dim);max-width:500px;text-align:center;line-height:1.5}
#setup-btn{padding:14px 40px;font-size:1.1rem;font-weight:700;background:var(--accent);color:#fff;border-radius:8px}
#setup-btn:hover{background:var(--accent2)}
#setup-btn:disabled{opacity:.5;cursor:wait}
#setup-log{color:var(--dim);font-size:.82rem;min-height:1.2em}
#setup-error{color:#e74c3c;font-size:.82rem;max-width:600px;word-break:break-all}

/* ── Top bar ── */
#top-bar{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#0d1b2a,var(--bg2));
  padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.badge{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.06);
  padding:4px 10px;border-radius:20px;font-size:.82rem;font-weight:600;border:1px solid rgba(255,255,255,.08)}
.badge .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
#turn-lbl{font-size:1.1rem;color:var(--gold);font-weight:700;margin-right:8px}
#player-lbl{font-size:.85rem;padding:4px 12px;border-radius:20px;font-weight:700}
.p0{background:var(--p0bg);color:var(--p0txt)}
.p1{background:var(--p1bg);color:var(--p1txt)}
#spacer{flex:1}
#end-btn{padding:6px 18px;background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff;
  font-size:.85rem;font-weight:700;border-radius:6px;box-shadow:0 2px 8px rgba(231,76,60,.3)}
#end-btn:hover{background:linear-gradient(135deg,#a93226,#c0392b)}
#end-btn:disabled{opacity:.5;cursor:wait}

/* ── Main layout ── */
#main{flex:1;display:flex;overflow:hidden}

/* ── Left sidebar ── */
#sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#sidebar-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.stab{flex:1;padding:8px 0;text-align:center;font-size:.78rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.5px;background:transparent;color:var(--dim);border-bottom:2px solid transparent;border-radius:0}
.stab.active{color:var(--gold);border-bottom-color:var(--gold);background:rgba(245,197,66,.06)}
.stab:hover{color:var(--text);background:rgba(255,255,255,.04)}
#sidebar-body{flex:1;overflow-y:auto;padding:6px}

/* sidebar cards */
.s-section{margin-bottom:10px}
.s-section-title{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--dim);
  padding:4px 8px;margin-bottom:2px}
.s-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--rad);cursor:pointer;
  border:1px solid transparent;margin-bottom:2px;transition:all .12s}
.s-card:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08)}
.s-card.selected{background:rgba(245,197,66,.1);border-color:var(--gold)}
.s-card.dead{opacity:.35;cursor:default}
.s-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;border:2px solid rgba(255,255,255,.15)}
.s-icon.p0{background:rgba(52,152,219,.25);border-color:rgba(52,152,219,.4)}
.s-icon.p1{background:rgba(231,76,60,.25);border-color:rgba(231,76,60,.4)}
.s-info{flex:1;min-width:0}
.s-name{font-size:.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.s-detail{font-size:.7rem;color:var(--dim)}
.s-hp{width:40px;text-align:right;flex-shrink:0}
.s-hp-bar{height:4px;border-radius:2px;background:#333;margin-top:2px}
.s-hp-fill{height:100%;border-radius:2px}

/* ── Map ── */
#map-area{flex:1;position:relative;overflow:hidden;background:#0a1628;cursor:grab}
#map-area.dragging{cursor:grabbing}
#map-canvas{position:absolute;top:0;left:0}
#tile-tip{position:absolute;pointer-events:none;background:rgba(10,22,40,.94);border:1px solid var(--border);
  border-radius:var(--rad);padding:8px 12px;font-size:.78rem;z-index:20;display:none;max-width:240px;backdrop-filter:blur(4px)}
#tile-tip b{color:var(--gold)}

/* ── Action mode banner ── */
#mode-banner{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(233,69,96,.9);
  color:#fff;padding:6px 20px;border-radius:20px;font-size:.82rem;font-weight:600;z-index:15;display:none}

/* ── Bottom action bar ── */
#action-bar{display:flex;align-items:center;gap:6px;background:linear-gradient(0deg,#0d1b2a,var(--bg2));
  border-top:1px solid var(--border);padding:8px 16px;flex-shrink:0;min-height:52px;flex-wrap:wrap}
#action-bar .label{font-size:.78rem;color:var(--dim);margin-right:4px}
#action-bar .sel-name{font-size:.88rem;font-weight:700;color:var(--gold);margin-right:12px}
.ab{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;font-size:.76rem;font-weight:600;
  background:rgba(255,255,255,.07);color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:var(--rad)}
.ab:hover{background:var(--panel);border-color:var(--accent)}
.ab.pri{background:var(--accent);color:#fff;border-color:var(--accent)}
.ab.pri:hover{background:var(--accent2)}
.ab.cancel{background:rgba(231,76,60,.15);color:#ec7063;border-color:rgba(231,76,60,.3)}
.ab.cancel:hover{background:rgba(231,76,60,.25)}

/* ── Right panel (tech / production) ── */
#rpanel{width:300px;background:var(--bg2);border-left:1px solid var(--border);display:none;flex-direction:column;flex-shrink:0;overflow:hidden}
#rpanel.open{display:flex}
#rp-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border)}
#rp-head h2{font-size:.9rem;font-weight:700;text-transform:uppercase;color:var(--gold)}
#rp-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.08);color:var(--text);font-size:1rem;border-radius:var(--rad)}
#rp-body{flex:1;overflow-y:auto;padding:10px}
.rp-item{padding:8px 10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);
  border-radius:var(--rad);font-size:.8rem;cursor:pointer;margin-bottom:4px;
  display:flex;justify-content:space-between;align-items:center}
.rp-item:hover{background:var(--panel);border-color:var(--accent)}
.rp-item .meta{font-size:.7rem;color:var(--dim)}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<!-- ═══ SETUP SCREEN ═══ -->
<div id="setup">
  <h1>CAIRO CIV</h1>
  <p>A fully on-chain Civilization game built with Cairo and StarkNet.<br>
     Make sure <code>katana --dev --dev.no-fee --dev.no-account-validation</code> is running.</p>
  <button id="setup-btn" onclick="doSetup()">Deploy &amp; Start Game</button>
  <div id="setup-log"></div>
  <div id="setup-error"></div>
</div>

<!-- ═══ GAME SCREEN ═══ -->
<div id="top-bar" style="display:none">
  <span id="turn-lbl">Turn 0</span>
  <span id="player-lbl" class="p0">Player A</span>
  <div class="badge"><span class="dot" style="background:var(--gold)"></span><span id="gold-lbl">0</span></div>
  <div class="badge"><span class="dot" style="background:var(--sci)"></span><span id="tech-lbl">--</span></div>
  <div class="badge"><span class="dot" style="background:var(--p1)"></span><span id="diplo-lbl">Peace</span></div>
  <div id="spacer"></div>
  <button class="ab" onclick="openPanel('tech')">Research</button>
  <button class="ab" onclick="openPanel('prod')">Production</button>
  <button id="end-btn" onclick="endTurn()">END TURN</button>
</div>

<div id="main" style="display:none">
  <!-- Left sidebar -->
  <div id="sidebar">
    <div id="sidebar-tabs">
      <button class="stab active" data-tab="mine" onclick="switchTab('mine')">My Forces</button>
      <button class="stab" data-tab="enemy" onclick="switchTab('enemy')">Enemy</button>
    </div>
    <div id="sidebar-body"></div>
  </div>

  <!-- Map -->
  <div id="map-area">
    <canvas id="map-canvas"></canvas>
    <div id="tile-tip"></div>
    <div id="mode-banner"></div>
  </div>

  <!-- Right panel (tech/prod picker) -->
  <div id="rpanel">
    <div id="rp-head"><h2 id="rp-title">Panel</h2><button id="rp-close" onclick="closePanel()">&#x2715;</button></div>
    <div id="rp-body"></div>
  </div>
</div>

<!-- Bottom action bar -->
<div id="action-bar" style="display:none">
  <span class="label">No selection</span>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════════
let G = null;           // game state from /api/state
let selected = null;    // {type:'unit'|'city', player, id, ...}
let actionMode = null;  // 'move'|'attack'|'ranged'|null
let loading = false;
let sidebarTab = 'mine';

// Map rendering
const COLS=32, ROWS=20, HW=52, HH=46;
let camX=0, camY=0;
let hoveredHex = null;

const TERRAIN_COLORS = [
  '#0b3d6e','#1a6fa0','#4a8c3f','#3d7a33','#8a9a3b','#7a8833',
  '#c2a84e','#b89840','#7a9a8a','#6a8a7a','#c8d8e0','#a8b8c0','#6b6b78'
];
const TERRAIN_NAMES = [
  'Ocean','Coast','Grassland','Grassland Hills','Plains','Plains Hills',
  'Desert','Desert Hills','Tundra','Tundra Hills','Snow','Snow Hills','Mountain'
];
const FEATURE_NAMES = ['','Woods','Marsh'];
const RESOURCE_NAMES = ['','Wheat','Cattle','Stone','Iron','Silver','Horses','Dyes'];
// Unit type indices match contract: 0=Settler, 1=Builder, 2=Scout, 3=Warrior, 4=Slinger, 5=Archer
const UNIT_NAMES  = ['Settler','Builder','Scout','Warrior','Slinger','Archer','Spearman','Horseman','Swordsman','Crossbowman','Catapult'];
const UNIT_ICONS  = ['\u{1F3D5}','\u{1F528}','\u{1F50D}','\u2694\uFE0F','\u{1F3AF}','\u{1F3F9}','\u{1F6E1}','\u{1F40E}','\u2694\uFE0F','\u{1F3F9}','\u{1F4A3}'];
const TECH_NAMES  = {1:'Mining',2:'Pottery',3:'Animal Husb.',4:'Archery',5:'Sailing',6:'Irrigation',7:'Writing',
  8:'Masonry',9:'Bronze Working',10:'The Wheel',11:'Currency',12:'Construction',13:'Horseback',14:'Iron Working',
  15:'Celestial Nav.',16:'Mathematics',17:'Engineering',18:'Machinery'};
const BUILDING_NAMES = {0:'Monument',1:'Granary',2:'Walls',3:'Library',4:'Market',5:'Barracks',6:'Water Mill'};
// Production item IDs match contract: PROD_SETTLER=1, PROD_BUILDER=2, PROD_SCOUT=3,
// PROD_WARRIOR=4, PROD_SLINGER=5, PROD_ARCHER=6, buildings start at 64
const PROD_ITEM_NAMES = {
  0:'None', 1:'Settler', 2:'Builder', 3:'Scout', 4:'Warrior', 5:'Slinger', 6:'Archer',
  64:'Monument', 65:'Granary', 66:'Walls', 67:'Library', 68:'Market', 69:'Barracks', 70:'Water Mill'
};
const PROD_ITEM_COST = {
  1:80, 2:50, 3:30, 4:40, 5:35, 6:60,
  64:60, 65:65, 66:80, 67:90, 68:100, 69:90, 70:80
};
function getBuildingList(bitmask) {
  const list = [];
  for (let i = 0; i < 7; i++) { if (bitmask & (1 << i)) list.push(BUILDING_NAMES[i]); }
  return list;
}

const canvas = document.getElementById('map-canvas');
const ctx2d = canvas.getContext('2d');

// ═══════════════════════════════════════════════════════════════
// SETUP
// ═══════════════════════════════════════════════════════════════
async function doSetup() {
  const btn = document.getElementById('setup-btn');
  const log = document.getElementById('setup-log');
  const err = document.getElementById('setup-error');
  btn.disabled = true; err.textContent = '';
  log.textContent = 'Connecting to Katana & deploying contract...';
  try {
    const res = await fetch('/api/setup', { method: 'POST' });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    log.textContent = 'Loading game state...';
    await refreshState();
    document.getElementById('setup').style.display = 'none';
    document.getElementById('top-bar').style.display = 'flex';
    document.getElementById('main').style.display = 'flex';
    document.getElementById('action-bar').style.display = 'flex';
    centerCamera();
    resizeCanvas();
  } catch (e) {
    err.textContent = 'Error: ' + e.message;
    btn.disabled = false;
    log.textContent = '';
  }
}

async function refreshState() {
  const res = await fetch('/api/state');
  G = await res.json();
  updateTopBar();
  renderSidebar();
  updateActionBar();
  drawMap();
}

function updateTopBar() {
  if (!G) return;
  document.getElementById('turn-lbl').textContent = 'Turn ' + G.turn;
  const pl = document.getElementById('player-lbl');
  pl.textContent = G.currentPlayer === 0 ? 'Player A' : 'Player B';
  pl.className = G.currentPlayer === 0 ? 'p0' : 'p1';
  const cp = G.players[G.currentPlayer];
  document.getElementById('gold-lbl').textContent = cp.treasury + ' gold';
  const techId = cp.currentResearch;
  document.getElementById('tech-lbl').textContent = techId ? TECH_NAMES[techId] || 'Tech '+techId : '--';
  document.getElementById('diplo-lbl').textContent = G.players[0].diplomacy === 1 ? 'WAR' : 'Peace';
}

// ═══════════════════════════════════════════════════════════════
// LEFT SIDEBAR
// ═══════════════════════════════════════════════════════════════
function switchTab(tab) {
  sidebarTab = tab;
  document.querySelectorAll('.stab').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  renderSidebar();
}

function renderSidebar() {
  if (!G) return;
  const body = document.getElementById('sidebar-body');
  const cp = G.currentPlayer;
  const p = sidebarTab === 'mine' ? cp : (1 - cp);
  const isMine = sidebarTab === 'mine';
  const pData = G.players[p];
  let html = '';

  // Cities section
  if (pData.cities.length > 0) {
    html += '<div class="s-section"><div class="s-section-title">Cities (' + pData.cities.length + ')</div>';
    for (const c of pData.cities) {
      const isSel = selected && selected.type === 'city' && selected.player === p && selected.id === c.id;
      const prodName = PROD_ITEM_NAMES[c.production] || 'None';
      const prodCost = PROD_ITEM_COST[c.production] || 0;
      const prodPct = prodCost > 0 ? Math.min(100, Math.round(c.prodStockpile / prodCost * 100)) : 0;
      const buildings = getBuildingList(c.buildings);
      html += `<div class="s-card${isSel ? ' selected' : ''}" onclick="selectFromSidebar('city',${p},${c.id})" style="flex-direction:column;align-items:stretch;gap:4px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="s-icon p${p}">\u{1F3DB}</div>
          <div class="s-info">
            <div class="s-name">${c.name}${c.isCapital ? ' \u2605' : ''}</div>
            <div class="s-detail">Pop ${c.population} \u2022 (${c.q},${c.r})</div>
          </div>
          <div class="s-hp">
            <div style="font-size:.7rem;text-align:right;color:var(--dim)">${c.hp}/200</div>
            <div class="s-hp-bar"><div class="s-hp-fill" style="width:${c.hp/2}%;background:${c.hp>100?'var(--food)':c.hp>50?'var(--prod)':'var(--p1)'}"></div></div>
          </div>
        </div>
        <div style="display:flex;gap:10px;font-size:.7rem;padding:0 4px">
          <span style="color:var(--food)">\u{1F33E} ${c.foodStockpile}</span>
          <span style="color:var(--prod)">\u2692 ${c.prodStockpile}${prodCost>0?'/'+prodCost:''}</span>
        </div>
        <div style="font-size:.68rem;padding:0 4px;color:var(--dim)">
          Producing: <b style="color:var(--prod)">${prodName}</b>${prodCost>0?' ('+prodPct+'%)':''}
        </div>
        <div style="padding:0 4px">
          <div class="s-hp-bar" style="height:3px"><div class="s-hp-fill" style="width:${prodPct}%;background:var(--prod)"></div></div>
        </div>
        ${buildings.length>0?'<div style="font-size:.65rem;padding:0 4px;color:var(--dim)">Buildings: '+buildings.join(', ')+'</div>':''}
      </div>`;
    }
    html += '</div>';
  }

  // Units section
  const alive = pData.units.filter(u => u.hp > 0);
  const dead = pData.units.filter(u => u.hp <= 0);
  if (alive.length > 0 || dead.length > 0) {
    html += '<div class="s-section"><div class="s-section-title">Units (' + alive.length + ' alive)</div>';
    for (const u of alive) {
      const isSel = selected && selected.type === 'unit' && selected.player === p && selected.id === u.id;
      const uname = UNIT_NAMES[u.unitType] || 'Unit';
      html += `<div class="s-card${isSel ? ' selected' : ''}" onclick="selectFromSidebar('unit',${p},${u.id})">
        <div class="s-icon p${p}">${UNIT_ICONS[u.unitType] || '?'}</div>
        <div class="s-info">
          <div class="s-name">${uname}</div>
          <div class="s-detail">MP:${u.mp}${u.charges ? ' Ch:'+u.charges : ''} \u2022 (${u.q},${u.r})</div>
        </div>
        <div class="s-hp">
          <div style="font-size:.7rem;text-align:right;color:var(--dim)">${u.hp}/100</div>
          <div class="s-hp-bar"><div class="s-hp-fill" style="width:${u.hp}%;background:${u.hp>50?'var(--food)':u.hp>25?'var(--prod)':'var(--p1)'}"></div></div>
        </div>
      </div>`;
    }
    for (const u of dead) {
      const uname = UNIT_NAMES[u.unitType] || 'Unit';
      html += `<div class="s-card dead">
        <div class="s-icon p${p}">${UNIT_ICONS[u.unitType] || '?'}</div>
        <div class="s-info"><div class="s-name">${uname}</div><div class="s-detail">Dead</div></div>
      </div>`;
    }
    html += '</div>';
  }

  // Treasury & research
  html += '<div class="s-section"><div class="s-section-title">Economy</div>';
  html += `<div style="padding:4px 10px;font-size:.78rem;color:var(--dim)">
    \u{1F4B0} Treasury: <b style="color:var(--gold)">${pData.treasury}</b><br>
    \u{1F52C} Research: <b style="color:var(--sci)">${TECH_NAMES[pData.currentResearch] || 'None'}</b><br>
    \u{1F3F3} Diplomacy: <b style="color:${pData.diplomacy===1?'var(--p1)':'var(--food)'}">${pData.diplomacy===1?'At War':'Peace'}</b>
  </div></div>`;

  if (html === '') html = '<div style="padding:20px;color:var(--dim);text-align:center;font-size:.82rem">No data yet</div>';
  body.innerHTML = html;
}

function selectFromSidebar(type, player, id) {
  if (!G) return;
  actionMode = null;
  setModeBanner(null);

  if (type === 'unit') {
    const u = G.players[player].units.find(x => x.id === id);
    if (!u || u.hp <= 0) return;
    selected = { ...u, type: 'unit', player };
    panToHex(u.q, u.r);
  } else {
    const c = G.players[player].cities.find(x => x.id === id);
    if (!c) return;
    selected = { ...c, type: 'city', player };
    panToHex(c.q, c.r);
  }
  updateActionBar();
  renderSidebar();
  drawMap();
}

function panToHex(q, r) {
  const [hx, hy] = hexCenter(q, r);
  camX = -hx + canvas.width / 2;
  camY = -hy + canvas.height / 2;
}

// ═══════════════════════════════════════════════════════════════
// BOTTOM ACTION BAR
// ═══════════════════════════════════════════════════════════════
function updateActionBar() {
  const bar = document.getElementById('action-bar');
  if (!selected) {
    bar.innerHTML = '<span class="label">Click a unit or city on the map, or select from the sidebar.</span>';
    return;
  }

  const isMine = selected.player === G.currentPlayer;

  if (selected.type === 'unit') {
    const u = selected;
    const name = UNIT_NAMES[u.unitType] || 'Unit';
    const icon = UNIT_ICONS[u.unitType] || '?';
    const isCivilian = u.unitType === 0 || u.unitType === 1; // 0=Settler, 1=Builder
    let html = `<span class="sel-name">${icon} ${name}</span>
      <span class="label">HP:${u.hp} MP:${u.mp}${u.charges ? ' Ch:'+u.charges : ''} (${u.q},${u.r})</span>`;

    if (isMine) {
      if (actionMode) {
        const modeName = actionMode === 'move' ? 'Move' : actionMode === 'attack' ? 'Attack' : 'Ranged Attack';
        html += `<button class="ab cancel" onclick="cancelMode()">Cancel ${modeName}</button>`;
      } else {
        html += `<button class="ab pri" onclick="startMove()">Move</button>`;
        if (u.unitType === 0) html += `<button class="ab pri" onclick="foundCity()">Found City</button>`;
        if (!isCivilian) {
          html += `<button class="ab" onclick="startAttack()">Attack</button>`;
          html += `<button class="ab" onclick="fortifyUnit()">Fortify</button>`;
          if (u.unitType === 4 || u.unitType === 5) html += `<button class="ab" onclick="startRanged()">Ranged</button>`; // 4=Slinger, 5=Archer
        }
        html += `<button class="ab" onclick="skipUnit()">Skip</button>`;
        html += `<button class="ab" onclick="declareWar()">Declare War</button>`;
      }
    } else {
      html += '<span class="label" style="margin-left:8px">Enemy unit</span>';
    }

    bar.innerHTML = html;
  } else if (selected.type === 'city') {
    const c = selected;
    const prodName = PROD_ITEM_NAMES[c.production] || 'None';
    const prodCost = PROD_ITEM_COST[c.production] || 0;
    const prodPct = prodCost > 0 ? Math.min(100, Math.round(c.prodStockpile / prodCost * 100)) : 0;
    const turnsLeft = prodCost > 0 && c.population > 0
      ? Math.max(1, Math.ceil((prodCost - c.prodStockpile) / Math.max(1, c.population)))
      : '\u221E';
    const buildings = getBuildingList(c.buildings);
    let html = `<span class="sel-name">\u{1F3DB} ${c.name}${c.isCapital?' \u2605':''}</span>`;
    html += `<span class="label">Pop:${c.population} HP:${c.hp} (${c.q},${c.r})</span>`;
    html += `<span class="badge" style="margin-left:4px"><span class="dot" style="background:var(--food)"></span>\u{1F33E} ${c.foodStockpile}</span>`;
    html += `<span class="badge"><span class="dot" style="background:var(--prod)"></span>\u2692 ${c.prodStockpile}/${prodCost} ${prodName} (~${turnsLeft}T)</span>`;
    if (buildings.length > 0) {
      html += `<span class="badge"><span class="dot" style="background:var(--sci)"></span>${buildings.join(', ')}</span>`;
    }
    if (isMine) {
      html += `<button class="ab pri" onclick="openPanel('prod')">Set Production</button>`;
      html += `<button class="ab" onclick="openPanel('tech')">Set Research</button>`;
    } else {
      html += '<span class="label" style="margin-left:8px">Enemy city</span>';
    }
    bar.innerHTML = html;
  }
}

// ═══════════════════════════════════════════════════════════════
// HEX GEOMETRY
// ═══════════════════════════════════════════════════════════════
function hexCenter(q, r) {
  const x = q * HW * 0.75 + HW / 2;
  const y = r * HH + HH / 2 + (q % 2 === 1 ? HH / 2 : 0);
  return [x, y];
}
function hexPts(cx, cy, s) {
  const p = [];
  for (let i = 0; i < 6; i++) { const a = Math.PI/6 + i*Math.PI/3; p.push([cx+s*Math.cos(a), cy+s*Math.sin(a)]); }
  return p;
}
function pixelToHex(px, py) {
  let best=null, bd=Infinity;
  for (let q=0;q<COLS;q++) for (let r=0;r<ROWS;r++) {
    const [hx,hy]=hexCenter(q,r); const d=(px-hx)**2+(py-hy)**2;
    if(d<bd){bd=d;best={q,r};}
  }
  return bd < HH*HH ? best : null;
}
function centerCamera() {
  if (!G) return;
  const cp = G.currentPlayer;
  const u = G.players[cp].units.find(u => u.hp > 0);
  if (u) panToHex(u.q, u.r);
}
function hexDist(q1,r1,q2,r2) {
  // offset hex distance
  function toAxial(q,r) {
    const aq = q;
    const ar = r - Math.floor(q / 2);
    return [aq, ar];
  }
  const [aq1,ar1] = toAxial(q1,r1);
  const [aq2,ar2] = toAxial(q2,r2);
  const dq = aq2-aq1, dr = ar2-ar1;
  return Math.max(Math.abs(dq), Math.abs(dr), Math.abs(dq+dr));
}

// ═══════════════════════════════════════════════════════════════
// MAP DRAWING
// ═══════════════════════════════════════════════════════════════
function resizeCanvas() {
  const area = document.getElementById('map-area');
  canvas.width = area.clientWidth;
  canvas.height = area.clientHeight;
  drawMap();
}
window.addEventListener('resize', resizeCanvas);

function getTile(q,r) {
  if (!G) return null;
  return G.tiles.find(t => t.q===q && t.r===r);
}

function drawMap() {
  if (!G) return;
  ctx2d.clearRect(0,0,canvas.width,canvas.height);
  ctx2d.save();
  ctx2d.translate(camX, camY);
  const sz = HH * 0.52;

  // Terrain
  for (const t of G.tiles) {
    const [cx,cy] = hexCenter(t.q, t.r);
    const pts = hexPts(cx,cy,sz);
    ctx2d.beginPath(); ctx2d.moveTo(pts[0][0],pts[0][1]);
    for(let i=1;i<6;i++) ctx2d.lineTo(pts[i][0],pts[i][1]);
    ctx2d.closePath();
    ctx2d.fillStyle = TERRAIN_COLORS[t.terrain] || '#333';
    ctx2d.fill();
    if (t.riverEdges) { ctx2d.strokeStyle='#3a9fd8'; ctx2d.lineWidth=2.5; }
    else { ctx2d.strokeStyle='rgba(0,0,0,.25)'; ctx2d.lineWidth=1; }
    ctx2d.stroke();

    if (t.feature===1) { ctx2d.font='12px sans-serif'; ctx2d.textAlign='center'; ctx2d.fillText('\u{1F332}',cx-6,cy-4); }
    if (t.feature===2) { ctx2d.font='12px sans-serif'; ctx2d.textAlign='center'; ctx2d.fillText('\u{1F33F}',cx-6,cy-4); }
    if (t.resource) { ctx2d.font='11px sans-serif'; ctx2d.textAlign='center'; ctx2d.fillText([,'\u{1F33E}','\u{1F404}','\u{1FAA8}','\u26CF\uFE0F','\u{1F48E}','\u{1F40E}','\u{1F3A8}'][t.resource]||'',cx+10,cy-6); }
    if (t.terrain===12) { ctx2d.font='16px sans-serif'; ctx2d.textAlign='center'; ctx2d.fillText('\u26F0\uFE0F',cx,cy+5); }
  }

  // Selected hex highlight
  if (selected) {
    const [cx,cy] = hexCenter(selected.q, selected.r);
    const pts = hexPts(cx,cy,sz+2);
    ctx2d.beginPath(); ctx2d.moveTo(pts[0][0],pts[0][1]);
    for(let i=1;i<6;i++) ctx2d.lineTo(pts[i][0],pts[i][1]);
    ctx2d.closePath(); ctx2d.strokeStyle='#f5c542'; ctx2d.lineWidth=3; ctx2d.stroke();
  }

  // Movement range highlight
  if (selected && selected.type==='unit' && actionMode==='move') {
    const range = selected.mp || 1;
    for (let dq=-range*2;dq<=range*2;dq++) for (let dr=-range*2;dr<=range*2;dr++) {
      const nq=selected.q+dq, nr=selected.r+dr;
      if(nq<0||nq>=COLS||nr<0||nr>=ROWS) continue;
      if(dq===0&&dr===0) continue;
      const tile = getTile(nq,nr);
      if(!tile || tile.terrain===0||tile.terrain===1||tile.terrain===12) continue;
      const dist = hexDist(selected.q,selected.r,nq,nr);
      if(dist>range) continue;
      const [hx,hy]=hexCenter(nq,nr);
      const hp=hexPts(hx,hy,sz);
      ctx2d.beginPath(); ctx2d.moveTo(hp[0][0],hp[0][1]);
      for(let i=1;i<6;i++) ctx2d.lineTo(hp[i][0],hp[i][1]);
      ctx2d.closePath(); ctx2d.fillStyle='rgba(245,197,66,.12)'; ctx2d.fill();
      ctx2d.strokeStyle='rgba(245,197,66,.35)'; ctx2d.lineWidth=1.5; ctx2d.stroke();
    }
  }

  // Attack range highlight
  if (selected && selected.type==='unit' && (actionMode==='attack'||actionMode==='ranged')) {
    const range = actionMode==='ranged' ? 2 : 1;
    for (let dq=-range*2;dq<=range*2;dq++) for (let dr=-range*2;dr<=range*2;dr++) {
      const nq=selected.q+dq, nr=selected.r+dr;
      if(nq<0||nq>=COLS||nr<0||nr>=ROWS) continue;
      if(dq===0&&dr===0) continue;
      const dist = hexDist(selected.q,selected.r,nq,nr);
      if(dist>range) continue;
      // Check if enemy unit here
      const enemy = 1 - G.currentPlayer;
      const hasEnemy = G.players[enemy].units.some(u => u.hp>0 && u.q===nq && u.r===nr);
      if (!hasEnemy) continue;
      const [hx,hy]=hexCenter(nq,nr);
      const hp=hexPts(hx,hy,sz);
      ctx2d.beginPath(); ctx2d.moveTo(hp[0][0],hp[0][1]);
      for(let i=1;i<6;i++) ctx2d.lineTo(hp[i][0],hp[i][1]);
      ctx2d.closePath(); ctx2d.fillStyle='rgba(231,76,60,.15)'; ctx2d.fill();
      ctx2d.strokeStyle='rgba(231,76,60,.5)'; ctx2d.lineWidth=2; ctx2d.stroke();
    }
  }

  // Hover highlight
  if (hoveredHex) {
    const [cx,cy] = hexCenter(hoveredHex.q, hoveredHex.r);
    const pts = hexPts(cx,cy,sz+1);
    ctx2d.beginPath(); ctx2d.moveTo(pts[0][0],pts[0][1]);
    for(let i=1;i<6;i++) ctx2d.lineTo(pts[i][0],pts[i][1]);
    ctx2d.closePath(); ctx2d.strokeStyle='rgba(255,255,255,.3)'; ctx2d.lineWidth=2; ctx2d.stroke();
  }

  // Cities
  for (let p=0;p<2;p++) {
    for (const c of G.players[p].cities) {
      const [cx,cy]=hexCenter(c.q,c.r);
      ctx2d.beginPath(); ctx2d.arc(cx,cy,14,0,Math.PI*2);
      ctx2d.fillStyle=p===0?'#2874a6':'#c0392b'; ctx2d.fill();
      ctx2d.strokeStyle='#fff'; ctx2d.lineWidth=2; ctx2d.stroke();
      ctx2d.font='bold 9px sans-serif'; ctx2d.textAlign='center'; ctx2d.fillStyle='#fff';
      ctx2d.fillText(c.name,cx,cy-18);
      ctx2d.font='8px sans-serif'; ctx2d.fillText('Pop '+c.population,cx,cy+4);
      // Production bar under city circle
      const prodCost = PROD_ITEM_COST[c.production] || 0;
      if (prodCost > 0) {
        const bw = 22, bh = 3, by = cy + 16;
        const pct = Math.min(1, c.prodStockpile / prodCost);
        ctx2d.fillStyle = '#333'; ctx2d.fillRect(cx-bw/2, by, bw, bh);
        ctx2d.fillStyle = '#ff9800'; ctx2d.fillRect(cx-bw/2, by, bw*pct, bh);
      }
    }
  }

  // Units
  for (let p=0;p<2;p++) {
    for (const u of G.players[p].units) {
      if (u.hp<=0) continue;
      const [cx,cy]=hexCenter(u.q,u.r);
      let ox=0, oy=0;
      const cityHere = G.players[p].cities.some(c=>c.q===u.q&&c.r===u.r);
      if(cityHere){ox=14;oy=-10;}
      ctx2d.beginPath(); ctx2d.arc(cx+ox,cy+oy-2,11,0,Math.PI*2);
      ctx2d.fillStyle=p===0?'#1a5276':'#922b21'; ctx2d.fill();
      const isSel = selected&&selected.type==='unit'&&selected.player===p&&selected.id===u.id;
      ctx2d.strokeStyle=isSel?'#f5c542':'rgba(255,255,255,.5)'; ctx2d.lineWidth=isSel?2.5:1.5; ctx2d.stroke();
      ctx2d.font='12px sans-serif'; ctx2d.textAlign='center';
      ctx2d.fillText(UNIT_ICONS[u.unitType]||'?',cx+ox,cy+oy+3);
      if (u.hp<100 && u.hp>0) {
        const bw=18;
        ctx2d.fillStyle='#333'; ctx2d.fillRect(cx+ox-bw/2,cy+oy+10,bw,3);
        ctx2d.fillStyle=u.hp>50?'#66bb6a':u.hp>25?'#ff9800':'#e74c3c';
        ctx2d.fillRect(cx+ox-bw/2,cy+oy+10,bw*u.hp/100,3);
      }
      ctx2d.font='7px sans-serif'; ctx2d.fillStyle='#ccc';
      ctx2d.fillText((UNIT_NAMES[u.unitType]||'Unit')+(p===1?' (B)':''),cx+ox,cy+oy+20);
    }
  }

  ctx2d.restore();
}

// ═══════════════════════════════════════════════════════════════
// MOUSE INTERACTION
// ═══════════════════════════════════════════════════════════════
let isDrag=false, dragSX,dragSY,dragCX,dragCY,dragMoved;
const mapArea = document.getElementById('map-area');

mapArea.addEventListener('mousedown', e => {
  if(e.button!==0) return;
  isDrag=true; dragMoved=false;
  dragSX=e.clientX; dragSY=e.clientY; dragCX=camX; dragCY=camY;
  mapArea.classList.add('dragging');
});
window.addEventListener('mousemove', e => {
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left-camX, my=e.clientY-rect.top-camY;
  if(isDrag){
    const dx=e.clientX-dragSX,dy=e.clientY-dragSY;
    if(Math.abs(dx)+Math.abs(dy)>4) dragMoved=true;
    camX=dragCX+dx; camY=dragCY+dy; drawMap();
    return;
  }
  const hex=pixelToHex(mx,my);
  if(hex&&(hex.q!==hoveredHex?.q||hex.r!==hoveredHex?.r)){
    hoveredHex=hex; drawMap(); showTooltip(e.clientX,e.clientY,hex);
  } else if(!hex){ hoveredHex=null; document.getElementById('tile-tip').style.display='none'; drawMap(); }
  else { const tt=document.getElementById('tile-tip'); tt.style.left=(e.clientX+14)+'px'; tt.style.top=(e.clientY+14)+'px'; }
});
window.addEventListener('mouseup', e => {
  if(isDrag&&!dragMoved){
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left-camX,my=e.clientY-rect.top-camY;
    const hex=pixelToHex(mx,my);
    if(hex) handleClick(hex);
  }
  isDrag=false; mapArea.classList.remove('dragging');
});
mapArea.addEventListener('wheel', e => {
  camX -= e.deltaX; camY -= e.deltaY; drawMap(); e.preventDefault();
}, {passive:false});

function showTooltip(mx,my,hex) {
  const tt=document.getElementById('tile-tip');
  const t=getTile(hex.q,hex.r);
  if(!t){tt.style.display='none';return;}
  let html=`<b>${TERRAIN_NAMES[t.terrain]||'?'}</b> (${hex.q},${hex.r})`;
  if(t.feature) html+=` \u2014 ${FEATURE_NAMES[t.feature]}`;
  if(t.resource) html+=`<br>Resource: ${RESOURCE_NAMES[t.resource]}`;
  for(let p=0;p<2;p++){
    for(const u of G.players[p].units){
      if(u.hp>0&&u.q===hex.q&&u.r===hex.r) html+=`<br>${p===0?'A':'B'}: ${UNIT_NAMES[u.unitType]} HP:${u.hp} MP:${u.mp}`;
    }
    for(const c of G.players[p].cities){
      if(c.q===hex.q&&c.r===hex.r) html+=`<br>${p===0?'A':'B'}: ${c.name} Pop:${c.population}`;
    }
  }
  tt.innerHTML=html; tt.style.display='block';
  tt.style.left=(mx+14)+'px'; tt.style.top=(my+14)+'px';
}

// ═══════════════════════════════════════════════════════════════
// CLICK / SELECTION / ACTIONS
// ═══════════════════════════════════════════════════════════════
function handleClick(hex) {
  if(loading) return;

  // If in action mode, execute the action
  if(actionMode==='move' && selected && selected.type==='unit') {
    doAction({type:'MoveUnit', unitId:selected.id, destQ:hex.q, destR:hex.r});
    return;
  }
  if(actionMode==='attack' && selected && selected.type==='unit') {
    doAction({type:'AttackUnit', unitId:selected.id, targetQ:hex.q, targetR:hex.r});
    return;
  }
  if(actionMode==='ranged' && selected && selected.type==='unit') {
    doAction({type:'RangedAttack', unitId:selected.id, targetQ:hex.q, targetR:hex.r});
    return;
  }

  // Try to select entity at this hex (prefer current player, then enemy)
  for (const p of [G.currentPlayer, 1 - G.currentPlayer]) {
    const unit = G.players[p].units.find(u => u.hp>0 && u.q===hex.q && u.r===hex.r);
    if (unit) {
      selected = {...unit, type:'unit', player:p};
      actionMode=null; setModeBanner(null);
      updateActionBar(); renderSidebar(); drawMap();
      return;
    }
    const city = G.players[p].cities.find(c => c.q===hex.q && c.r===hex.r);
    if (city) {
      selected = {...city, type:'city', player:p};
      actionMode=null; setModeBanner(null);
      updateActionBar(); renderSidebar(); drawMap();
      return;
    }
  }

  // Nothing at this hex
  selected=null; actionMode=null; setModeBanner(null);
  updateActionBar(); renderSidebar(); drawMap();
}

function setModeBanner(text) {
  const b = document.getElementById('mode-banner');
  if(!text){ b.style.display='none'; return; }
  b.textContent=text; b.style.display='block';
}

function cancelMode() { actionMode=null; setModeBanner(null); updateActionBar(); drawMap(); }
function startMove()  { actionMode='move';   setModeBanner('Click destination hex to move'); updateActionBar(); drawMap(); }
function startAttack(){ actionMode='attack'; setModeBanner('Click enemy unit to attack (melee)'); updateActionBar(); drawMap(); }
function startRanged(){ actionMode='ranged'; setModeBanner('Click enemy unit for ranged attack'); updateActionBar(); drawMap(); }

// Single action — does NOT auto-end the turn
async function doAction(action) {
  actionMode=null; setModeBanner(null);
  await submitActions([action]);
}

async function foundCity() {
  if(!selected||selected.unitType!==0) return;
  const name = prompt('City name:', 'City');
  if(!name) return;
  await submitActions([{type:'FoundCity', settlerId:selected.id, name}]);
}

async function fortifyUnit() {
  if(!selected) return;
  await submitActions([{type:'FortifyUnit', unitId:selected.id}]);
}

async function skipUnit() {
  if(!selected) return;
  await submitActions([{type:'SkipUnit', unitId:selected.id}]);
}

async function declareWar() {
  if (!confirm('Declare war on the other player?')) return;
  const target = G.currentPlayer === 0 ? 1 : 0;
  await submitActions([{type:'DeclareWar', target}]);
}

async function endTurn() {
  await submitActions([{type:'EndTurn'}]);
}

async function submitActions(actions) {
  if(loading) return;
  loading=true;
  document.getElementById('end-btn').disabled=true;
  try {
    const res = await fetch('/api/turn', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({player: G.currentPlayer, actions})
    });
    const data = await res.json();
    if(!res.ok) { alert('Error: ' + data.error); loading=false; document.getElementById('end-btn').disabled=false; return; }
    selected=null; actionMode=null; setModeBanner(null);
    await refreshState();
    // Only re-center on End Turn
    if (actions.some(a => a.type === 'EndTurn')) centerCamera();
  } catch(e) { alert('Error: '+e.message); }
  loading=false;
  document.getElementById('end-btn').disabled=false;
}

// ═══════════════════════════════════════════════════════════════
// RIGHT PANEL (Tech / Production)
// ═══════════════════════════════════════════════════════════════
function openPanel(type) {
  const panel = document.getElementById('rpanel');
  const title = document.getElementById('rp-title');
  const body  = document.getElementById('rp-body');
  panel.classList.add('open');

  if(type==='tech') {
    title.textContent='Set Research';
    let html='';
    for(let id=1;id<=18;id++){
      html+=`<div class="rp-item" onclick="setResearch(${id})"><span>\u{1F52C} ${TECH_NAMES[id]}</span><span class="meta">ID ${id}</span></div>`;
    }
    body.innerHTML=html;
  } else if(type==='prod') {
    title.textContent='Set Production';
    // IDs match contract: PROD_SETTLER=1, PROD_BUILDER=2, PROD_SCOUT=3,
    // PROD_WARRIOR=4, PROD_SLINGER=5, PROD_ARCHER=6, buildings at 64+
    const items = [
      {id:1,name:'Settler',cost:80},{id:2,name:'Builder',cost:50},{id:3,name:'Scout',cost:30},
      {id:4,name:'Warrior',cost:40},{id:5,name:'Slinger',cost:35},{id:6,name:'Archer',cost:60},
      {id:64,name:'Monument',cost:60},{id:65,name:'Granary',cost:65},
      {id:66,name:'Walls',cost:80},{id:67,name:'Library',cost:90},{id:68,name:'Market',cost:100},
      {id:69,name:'Barracks',cost:90},{id:70,name:'Water Mill',cost:80},
    ];
    let html='';
    for(const it of items){
      const cat = it.id >= 64 ? 'Building' : 'Unit';
      html+=`<div class="rp-item" onclick="setProduction(${it.id})"><span>\u{1F3D7} ${it.name}</span><span class="meta">${cat} \u2022 \u2692${it.cost}</span></div>`;
    }
    body.innerHTML=html;
  }
  setTimeout(resizeCanvas, 50);
}
function closePanel() {
  document.getElementById('rpanel').classList.remove('open');
  setTimeout(resizeCanvas, 50);
}

async function setResearch(techId) {
  closePanel();
  await submitActions([{type:'SetResearch', techId}]);
}

async function setProduction(itemId) {
  if(!selected || selected.type!=='city') {
    const cp = G.currentPlayer;
    const city = G.players[cp].cities[0];
    if(!city){ alert('No city to set production'); closePanel(); return; }
    closePanel();
    await submitActions([{type:'SetProduction', cityId:city.id, itemId}]);
  } else {
    closePanel();
    await submitActions([{type:'SetProduction', cityId:selected.id, itemId}]);
  }
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
setTimeout(resizeCanvas, 50);
</script>
</body>
</html>
