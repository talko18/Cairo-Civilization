<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Civilization VI (Base Game) - Turn Actions</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#1a1a2e; --bg-light:#16213e; --bg-panel:#0f3460;
      --accent:#e94560; --gold:#f5c542; --text:#e0e0e0; --text-dim:#8899aa;
      --science:#4fc3f7; --culture:#ba68c8; --faith:#e0e0e0;
      --food:#66bb6a; --prod:#ff9800; --border:#2a3a5e; --radius:6px;
    }
    html,body{height:100%;overflow:hidden;}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}
    button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--radius);transition:background .15s,transform .1s,box-shadow .15s;}
    button:hover{transform:translateY(-1px);} button:active{transform:translateY(0);}

    /* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #top-bar{display:flex;align-items:center;gap:6px;background:linear-gradient(180deg,#0d1b2a,var(--bg-light));padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;z-index:10;}
    #turn-info{display:flex;align-items:center;gap:12px;margin-right:auto;font-weight:600;}
    #turn-info .turn{font-size:1.1rem;color:var(--gold);}
    #turn-info .era{font-size:.85rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;}
    .yield-badge{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.06);padding:4px 10px;border-radius:20px;font-size:.82rem;font-weight:600;border:1px solid rgba(255,255,255,.08);}
    .yield-badge .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main{flex:1;display:flex;overflow:hidden;}

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar{width:58px;background:var(--bg-light);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:2px;flex-shrink:0;overflow-y:auto;}
    .sb-btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:transparent;color:var(--text-dim);font-size:1.2rem;border-radius:var(--radius);position:relative;}
    .sb-btn:hover,.sb-btn.active{background:var(--bg-panel);color:#fff;}
    .sb-btn.active::after{content:'';position:absolute;left:0;top:25%;bottom:25%;width:3px;background:var(--accent);border-radius:0 3px 3px 0;}
    .sb-btn .tooltip{display:none;position:absolute;left:54px;background:#111;color:#fff;padding:4px 10px;border-radius:4px;font-size:.75rem;white-space:nowrap;z-index:100;pointer-events:none;}
    .sb-btn:hover .tooltip{display:block;}
    .sb-divider{width:30px;height:1px;background:var(--border);margin:4px 0;}

    /* â”€â”€ Center â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #center{flex:1;display:flex;flex-direction:column;min-width:0;}

    /* â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #map-area{flex:1;position:relative;overflow:hidden;background:#0a1628;cursor:grab;}
    #map-area.dragging{cursor:grabbing;}
    #map-canvas{position:absolute;top:0;left:0;}

    /* Tile tooltip */
    #tile-tooltip{position:absolute;pointer-events:none;background:rgba(10,22,40,.94);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;font-size:.78rem;color:var(--text);z-index:20;display:none;max-width:220px;backdrop-filter:blur(4px);}
    #tile-tooltip .tt-title{font-weight:700;color:var(--gold);margin-bottom:3px;}
    #tile-tooltip .tt-yields{display:flex;gap:8px;margin-top:4px;}
    #tile-tooltip .tt-yields span{display:flex;align-items:center;gap:2px;}

    /* Minimap */
    #minimap{position:absolute;bottom:10px;right:10px;border:2px solid var(--border);border-radius:var(--radius);overflow:hidden;z-index:15;background:#0a1628;box-shadow:0 4px 16px rgba(0,0,0,.5);}
    #minimap-canvas{display:block;}
    #minimap-viewport{position:absolute;border:1.5px solid var(--gold);pointer-events:none;border-radius:2px;}

    /* Notifications */
    #notifications{position:absolute;top:12px;right:12px;display:flex;flex-direction:column;gap:6px;width:260px;z-index:15;}
    .notif{background:rgba(15,52,96,.92);border:1px solid var(--border);border-left:3px solid var(--gold);padding:8px 12px;border-radius:var(--radius);font-size:.78rem;backdrop-filter:blur(6px);animation:slideIn .3s ease;}
    @keyframes slideIn{from{opacity:0;transform:translateX(30px);}to{opacity:1;transform:translateX(0);}}

    /* â”€â”€ Bottom Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #bottom-bar{display:flex;align-items:stretch;background:linear-gradient(0deg,#0d1b2a,var(--bg-light));border-top:1px solid var(--border);flex-shrink:0;z-index:10;}
    #context-panel{flex:1;padding:10px 16px;min-height:110px;max-height:150px;overflow-y:auto;}
    #context-panel h3{font-size:.85rem;text-transform:uppercase;letter-spacing:1px;color:var(--gold);margin-bottom:6px;}
    .action-grid{display:flex;flex-wrap:wrap;gap:5px;}
    .action-btn{display:flex;align-items:center;gap:5px;padding:5px 10px;font-size:.76rem;font-weight:600;background:rgba(255,255,255,.07);color:var(--text);border:1px solid rgba(255,255,255,.1);}
    .action-btn:hover{background:var(--bg-panel);border-color:var(--accent);box-shadow:0 0 8px rgba(233,69,96,.25);}
    .action-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
    .action-btn.primary:hover{background:#d63050;box-shadow:0 0 12px rgba(233,69,96,.4);}
    .action-btn .icon{font-size:.95rem;}
    #end-turn-area{display:flex;align-items:center;padding:10px 16px;border-left:1px solid var(--border);}
    #end-turn-btn{width:100px;height:70px;background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff;font-size:.95rem;font-weight:700;letter-spacing:.5px;border-radius:8px;box-shadow:0 4px 16px rgba(231,76,60,.35);}
    #end-turn-btn:hover{background:linear-gradient(135deg,#a93226,#c0392b);box-shadow:0 6px 20px rgba(231,76,60,.5);}
    #end-turn-btn .sub{display:block;font-size:.62rem;font-weight:400;opacity:.8;margin-top:2px;}

    /* â”€â”€ Right Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #right-panel{width:360px;background:var(--bg-light);border-left:1px solid var(--border);display:none;flex-direction:column;flex-shrink:0;overflow:hidden;}
    #right-panel.open{display:flex;}
    #rp-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);}
    #rp-header h2{font-size:.95rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
    #rp-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.08);color:var(--text);font-size:1rem;}
    #rp-body{flex:1;overflow-y:auto;padding:14px;}
    .panel-section{margin-bottom:18px;}
    .panel-section h4{font-size:.78rem;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);}
    .panel-list{list-style:none;display:flex;flex-direction:column;gap:4px;}
    .panel-list li{padding:7px 10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s;}
    .panel-list li:hover{background:var(--bg-panel);border-color:var(--accent);}
    .panel-list li .meta{margin-left:auto;font-size:.7rem;color:var(--text-dim);}
    .panel-list li .icon{font-size:1rem;}
    .policy-slots{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
    .policy-slot{width:100%;padding:7px 10px;border-radius:var(--radius);font-size:.76rem;cursor:pointer;border:1px dashed;display:flex;align-items:center;gap:6px;}
    .policy-slot.military{border-color:#e74c3c;background:rgba(231,76,60,.08);}
    .policy-slot.economic{border-color:#f1c40f;background:rgba(241,196,15,.08);}
    .policy-slot.diplomatic{border-color:#2ecc71;background:rgba(46,204,113,.08);}
    .policy-slot.wildcard{border-color:#9b59b6;background:rgba(155,89,182,.08);}
    .policy-slot:hover{opacity:.8;}
    .slot-label{font-weight:600;} .slot-card{color:var(--text-dim);font-style:italic;}
    .civ-card{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:background .15s;}
    .civ-card:hover{background:var(--bg-panel);border-color:var(--accent);}
    .civ-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
    .civ-info{flex:1;} .civ-info .name{font-weight:700;font-size:.83rem;} .civ-info .leader{font-size:.7rem;color:var(--text-dim);}
    .diplo-actions{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;} .diplo-actions .action-btn{font-size:.73rem;}
    ::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
  </style>
</head>
<body>

<!-- â•â•â• TOP BAR â•â•â• -->
<div id="top-bar">
  <div id="turn-info"><span class="turn">Turn 42</span><span class="era">Classical Era</span></div>
  <div class="yield-badge"><span class="dot" style="background:var(--food)"></span><span>+12</span></div>
  <div class="yield-badge"><span class="dot" style="background:var(--prod)"></span><span>+18</span></div>
  <div class="yield-badge"><span class="dot" style="background:var(--gold)"></span><span>230</span></div>
  <div class="yield-badge"><span class="dot" style="background:var(--science)"></span><span>+24</span></div>
  <div class="yield-badge"><span class="dot" style="background:var(--culture)"></span><span>+16</span></div>
  <div class="yield-badge"><span class="dot" style="background:var(--faith)"></span><span>+8</span></div>
</div>

<!-- â•â•â• MAIN â•â•â• -->
<div id="main">
  <nav id="sidebar">
    <button class="sb-btn" data-panel="research">ğŸ”¬<span class="tooltip">Research</span></button>
    <button class="sb-btn" data-panel="civics">ğŸ“œ<span class="tooltip">Civics</span></button>
    <div class="sb-divider"></div>
    <button class="sb-btn" data-panel="government">ğŸ›ï¸<span class="tooltip">Government</span></button>
    <button class="sb-btn" data-panel="diplomacy">ğŸ¤<span class="tooltip">Diplomacy</span></button>
    <button class="sb-btn" data-panel="religion">â›ª<span class="tooltip">Religion</span></button>
    <div class="sb-divider"></div>
    <button class="sb-btn" data-panel="greatpeople">â­<span class="tooltip">Great People</span></button>
    <button class="sb-btn" data-panel="trade">ğŸš¢<span class="tooltip">Trade Routes</span></button>
    <button class="sb-btn" data-panel="espionage">ğŸ•µï¸<span class="tooltip">Espionage</span></button>
    <button class="sb-btn" data-panel="citystates">ğŸ˜ï¸<span class="tooltip">City-States</span></button>
    <div class="sb-divider"></div>
    <button class="sb-btn" data-panel="rankings">ğŸ“Š<span class="tooltip">Rankings</span></button>
  </nav>

  <div id="center">
    <!-- â•â•â• MAP â•â•â• -->
    <div id="map-area">
      <canvas id="map-canvas"></canvas>
      <div id="tile-tooltip"></div>
      <div id="notifications">
        <div class="notif">âš”ï¸ Barbarian Outpost spotted to the north</div>
        <div class="notif">ğŸ”¬ Research: Archery complete â€” choose next tech</div>
        <div class="notif">ğŸ—ï¸ Rome needs a new production order</div>
      </div>
      <div id="minimap">
        <canvas id="minimap-canvas" width="180" height="120"></canvas>
        <div id="minimap-viewport"></div>
      </div>
    </div>

    <!-- â•â•â• BOTTOM BAR â•â•â• -->
    <div id="bottom-bar">
      <div id="context-panel">
        <h3>No Selection</h3>
        <p style="font-size:.8rem;color:var(--text-dim);">Click a unit or city on the map to see available actions.</p>
      </div>
      <div id="end-turn-area">
        <button id="end-turn-btn" onclick="endTurn()">END TURN<span class="sub">Turn 42 â†’ 43</span></button>
      </div>
    </div>
  </div>

  <!-- â•â•â• RIGHT PANEL â•â•â• -->
  <div id="right-panel">
    <div id="rp-header"><h2 id="rp-title">Panel</h2><button id="rp-close" onclick="closePanel()">âœ•</button></div>
    <div id="rp-body"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEX MAP ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const COLS = 26, ROWS = 18;
const HEX_W = 64, HEX_H = 56;
const HEX_SIDE = HEX_H / 2;

// Terrain types
const T = {
  OCEAN:0, COAST:1, GRASSLAND:2, PLAINS:3, DESERT:4, TUNDRA:5,
  GRASS_HILL:6, PLAINS_HILL:7, MOUNTAIN:8, WOODS:9, RAINFOREST:10, MARSH:11
};
const TERRAIN_META = {
  [T.OCEAN]:      {name:'Ocean',       color:'#0b3d6e', food:1,prod:0,gold:0},
  [T.COAST]:      {name:'Coast',       color:'#1a6fa0', food:1,prod:0,gold:1},
  [T.GRASSLAND]:  {name:'Grassland',   color:'#4a8c3f', food:2,prod:0,gold:0},
  [T.PLAINS]:     {name:'Plains',      color:'#8a9a3b', food:1,prod:1,gold:0},
  [T.DESERT]:     {name:'Desert',      color:'#c2a84e', food:0,prod:0,gold:0},
  [T.TUNDRA]:     {name:'Tundra',      color:'#7a9a8a', food:1,prod:0,gold:0},
  [T.GRASS_HILL]: {name:'Grassland Hills',color:'#3d7a33', food:2,prod:1,gold:0},
  [T.PLAINS_HILL]:{name:'Plains Hills',color:'#7a8833', food:1,prod:2,gold:0},
  [T.MOUNTAIN]:   {name:'Mountain',    color:'#6b6b78', food:0,prod:0,gold:0},
  [T.WOODS]:      {name:'Woods',       color:'#2d6b2d', food:0,prod:1,gold:0},
  [T.RAINFOREST]: {name:'Rainforest',  color:'#1a5a2a', food:1,prod:0,gold:0},
  [T.MARSH]:      {name:'Marsh',       color:'#4a7a5a', food:0,prod:-1,gold:0},
};

// Map seed (procedural but deterministic)
function seededRandom(seed) { let s=seed; return ()=>{s=(s*16807+0)%2147483647; return (s-1)/2147483646;} }
const rand = seededRandom(42);

// Generate terrain
const map = [];
for (let r = 0; r < ROWS; r++) {
  map[r] = [];
  for (let c = 0; c < COLS; c++) {
    // Ocean border
    if (r < 1 || r >= ROWS-1 || c < 1 || c >= COLS-1) { map[r][c] = T.OCEAN; continue; }
    if (r < 2 || r >= ROWS-2 || c < 2 || c >= COLS-2) { map[r][c] = rand() < .6 ? T.COAST : T.OCEAN; continue; }
    // Interior
    const v = rand();
    if (v < .02) map[r][c] = T.MOUNTAIN;
    else if (v < .08) map[r][c] = T.GRASS_HILL;
    else if (v < .14) map[r][c] = T.PLAINS_HILL;
    else if (v < .20) map[r][c] = T.WOODS;
    else if (v < .24) map[r][c] = T.RAINFOREST;
    else if (v < .26) map[r][c] = T.MARSH;
    else if (v < .30) map[r][c] = T.DESERT;
    else if (v < .32) map[r][c] = T.TUNDRA;
    else if (v < .33) map[r][c] = T.COAST;
    else if (v < .60) map[r][c] = T.GRASSLAND;
    else map[r][c] = T.PLAINS;
  }
}
// Carve a river path (visual only - mark some tiles as coast-adjacent)
const riverTiles = new Set();
let rx = 5, ry = 3;
for (let i = 0; i < 12; i++) { riverTiles.add(`${ry},${rx}`); rx += rand()>.4?1:0; ry += rand()>.3?1:0; if(ry>=ROWS-2)break; }

// Resources (bonus/luxury/strategic)
const resources = {};
const RES_ICONS = {wheat:'ğŸŒ¾',cattle:'ğŸ„',iron:'â›ï¸',horses:'ğŸ´',gold_res:'ğŸ’',fish:'ğŸŸ',stone:'ğŸª¨',silk:'ğŸ§µ'};
const resTypes = Object.keys(RES_ICONS);
for (let i = 0; i < 20; i++) {
  const rr = 3+Math.floor(rand()*(ROWS-6)), rc = 3+Math.floor(rand()*(COLS-6));
  const t = map[rr][rc];
  if (t >= T.GRASSLAND && t !== T.MOUNTAIN) {
    resources[`${rr},${rc}`] = resTypes[Math.floor(rand()*resTypes.length)];
  }
}

// Improvements
const improvements = {};

// Units & Cities
const entities = [
  {type:'city', name:'Rome',   r:8,  c:10, civ:'rome', pop:7},
  {type:'city', name:'Antium', r:12, c:14, civ:'rome', pop:4},
  {type:'unit', name:'Warrior',r:7,  c:9,  icon:'âš”ï¸', cls:'warrior', hp:85, hpMax:100, cs:20, mp:2, mpMax:2},
  {type:'unit', name:'Archer', r:9,  c:11, icon:'ğŸ¹', cls:'archer',  hp:100,hpMax:100, cs:15, mp:2, mpMax:2},
  {type:'unit', name:'Settler',r:6,  c:12, icon:'ğŸ•ï¸', cls:'settler', hp:0,  hpMax:0,   cs:0,  mp:2, mpMax:2},
  {type:'unit', name:'Builder',r:9,  c:9,  icon:'ğŸ”¨', cls:'builder', hp:0,  hpMax:0,   cs:0,  mp:2, mpMax:2, charges:3},
  {type:'unit', name:'Scout',  r:5,  c:7,  icon:'ğŸ”', cls:'scout',   hp:100,hpMax:100, cs:10, mp:3, mpMax:3},
  {type:'unit', name:'Trader', r:8,  c:11, icon:'ğŸ“¦', cls:'trader',  hp:0,  hpMax:0,   cs:0,  mp:1, mpMax:1},
  // Enemy / barbarian
  {type:'barb', name:'Barbarian Outpost', r:4, c:8, icon:'ğŸ´'},
  {type:'barb', name:'Barbarian Warrior', r:5, c:8, icon:'ğŸ—¡ï¸'},
  // Other civ
  {type:'foreign',name:'Thebes',r:6, c:19, icon:'ğŸ›ï¸', civ:'egypt'},
  {type:'foreign',name:'Egyptian Warrior',r:7, c:18, icon:'âš”ï¸', civ:'egypt'},
];

// Fog of war: tiles visible from your units/cities (simplified: 3-tile radius from own stuff)
const visible = new Set();
const explored = new Set();
entities.filter(e => e.civ === 'rome' || e.cls).forEach(e => {
  if (!e.r && e.r!==0) return;
  const sight = e.type === 'city' ? 4 : (e.cls === 'scout' ? 4 : 3);
  for (let dr = -sight; dr <= sight; dr++)
    for (let dc = -sight; dc <= sight; dc++) {
      const nr = e.r+dr, nc = e.c+dc;
      if (nr>=0 && nr<ROWS && nc>=0 && nc<COLS && Math.abs(dr)+Math.abs(dc) <= sight+1) {
        visible.add(`${nr},${nc}`);
        explored.add(`${nr},${nc}`);
      }
    }
});
// Also mark some extra explored tiles
for (let r = 0; r < ROWS; r++)
  for (let c = 0; c < COLS; c++)
    if (rand() < .35 || (r > 2 && r < ROWS-2 && c > 2 && c < COLS-2)) explored.add(`${r},${c}`);

// Districts (show as colored markers on city tiles)
const districts = [
  {r:7, c:10, type:'Campus',       icon:'ğŸ”¬'},
  {r:8, c:9,  type:'Holy Site',    icon:'â›ª'},
  {r:9, c:10, type:'Commercial Hub',icon:'ğŸ’°'},
  {r:11,c:14, type:'Encampment',   icon:'ğŸ°'},
  {r:12,c:13, type:'Theater Sq.',  icon:'ğŸ­'},
];

// â”€â”€ Canvas setup â”€â”€
const canvas = document.getElementById('map-canvas');
const ctx = canvas.getContext('2d');
const mapW = COLS * HEX_W * 0.75 + HEX_W * 0.25;
const mapH = ROWS * HEX_H + HEX_H / 2;

let camX = -(mapW/2 - window.innerWidth/2 + 58);
let camY = -(mapH/2 - window.innerHeight/2 + 50);
let selectedEntity = null;
let hoveredHex = null;

function resizeCanvas() {
  const area = document.getElementById('map-area');
  canvas.width = area.clientWidth;
  canvas.height = area.clientHeight;
  drawMap();
}
window.addEventListener('resize', resizeCanvas);

// Hex geometry (pointy-top)
function hexCenter(r, c) {
  const x = c * HEX_W * 0.75 + HEX_W / 2;
  const y = r * HEX_H + HEX_H / 2 + (c % 2 === 1 ? HEX_H / 2 : 0);
  return [x, y];
}
function hexPath(cx, cy, size) {
  const pts = [];
  for (let i = 0; i < 6; i++) {
    const a = Math.PI / 6 + i * Math.PI / 3;
    pts.push([cx + size * Math.cos(a), cy + size * Math.sin(a)]);
  }
  return pts;
}
function pixelToHex(px, py) {
  // Brute-force: find closest hex center
  let best = null, bestDist = Infinity;
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c < COLS; c++) {
      const [hx, hy] = hexCenter(r, c);
      const dx = px - hx, dy = py - hy;
      const d = dx*dx + dy*dy;
      if (d < bestDist) { bestDist = d; best = {r, c}; }
    }
  if (bestDist < (HEX_H*HEX_H)) return best;
  return null;
}

// â”€â”€ Draw â”€â”€
function drawMap() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(camX, camY);

  const size = HEX_H * 0.52;

  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const key = `${r},${c}`;
      const [cx, cy] = hexCenter(r, c);
      const pts = hexPath(cx, cy, size);

      // Visibility
      const isVisible = visible.has(key);
      const isExplored = explored.has(key);

      // Terrain color
      const terrain = map[r][c];
      const meta = TERRAIN_META[terrain];
      let color = meta.color;

      // Draw hex
      ctx.beginPath();
      ctx.moveTo(pts[0][0], pts[0][1]);
      for (let i = 1; i < 6; i++) ctx.lineTo(pts[i][0], pts[i][1]);
      ctx.closePath();

      if (!isExplored) {
        ctx.fillStyle = '#080e18';
        ctx.fill();
        continue;
      }

      ctx.fillStyle = color;
      ctx.fill();

      // River edge highlight
      if (riverTiles.has(key)) {
        ctx.strokeStyle = '#3a9fd8';
        ctx.lineWidth = 2.5;
        ctx.stroke();
      } else {
        ctx.strokeStyle = 'rgba(0,0,0,.25)';
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      // Fog overlay for explored but not visible
      if (!isVisible) {
        ctx.fillStyle = 'rgba(8,14,24,.55)';
        ctx.fill();
      }

      if (!isVisible) continue;

      // Resource icon
      const res = resources[key];
      if (res) {
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(RES_ICONS[res], cx + 12, cy - 8);
      }

      // Yield dots (small colored dots at bottom of hex)
      const f = meta.food, p = meta.prod, g = meta.gold;
      let dots = [];
      for (let i=0;i<f;i++) dots.push('#66bb6a');
      for (let i=0;i<p;i++) dots.push('#ff9800');
      for (let i=0;i<g;i++) dots.push('#f5c542');
      const dotY = cy + size * 0.55;
      const dotStart = cx - (dots.length - 1) * 4;
      dots.forEach((dc, i) => {
        ctx.beginPath();
        ctx.arc(dotStart + i * 8, dotY, 2.5, 0, Math.PI * 2);
        ctx.fillStyle = dc;
        ctx.fill();
      });

      // Mountain symbol
      if (terrain === T.MOUNTAIN) {
        ctx.font = '20px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('â›°ï¸', cx, cy + 6);
      }
      // Woods / Rainforest tree
      if (terrain === T.WOODS || terrain === T.RAINFOREST) {
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(terrain === T.WOODS ? 'ğŸŒ²' : 'ğŸŒ´', cx - 8, cy - 4);
      }
    }
  }

  // Districts
  districts.forEach(d => {
    const [cx, cy] = hexCenter(d.r, d.c);
    if (!visible.has(`${d.r},${d.c}`)) return;
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(d.icon, cx, cy + 5);
    ctx.font = '8px sans-serif';
    ctx.fillStyle = '#aaa';
    ctx.fillText(d.type, cx, cy + 16);
  });

  // Selected hex highlight
  if (selectedEntity) {
    const [cx, cy] = hexCenter(selectedEntity.r, selectedEntity.c);
    const pts = hexPath(cx, cy, size + 2);
    ctx.beginPath();
    ctx.moveTo(pts[0][0], pts[0][1]);
    for (let i = 1; i < 6; i++) ctx.lineTo(pts[i][0], pts[i][1]);
    ctx.closePath();
    ctx.strokeStyle = '#f5c542';
    ctx.lineWidth = 3;
    ctx.stroke();

    // Movement range highlight
    if (selectedEntity.mpMax) {
      const range = selectedEntity.mpMax;
      for (let dr = -range; dr <= range; dr++)
        for (let dc = -range; dc <= range; dc++) {
          if (dr === 0 && dc === 0) continue;
          const nr = selectedEntity.r + dr, nc = selectedEntity.c + dc;
          if (nr < 0 || nr >= ROWS || nc < 0 || nc >= COLS) continue;
          if (Math.abs(dr) + Math.abs(dc) > range + 1) continue;
          const t = map[nr][nc];
          if (t === T.OCEAN || t === T.COAST || t === T.MOUNTAIN) continue;
          const [hx, hy] = hexCenter(nr, nc);
          const hpts = hexPath(hx, hy, size);
          ctx.beginPath();
          ctx.moveTo(hpts[0][0], hpts[0][1]);
          for (let i = 1; i < 6; i++) ctx.lineTo(hpts[i][0], hpts[i][1]);
          ctx.closePath();
          ctx.fillStyle = 'rgba(245,197,66,.12)';
          ctx.fill();
          ctx.strokeStyle = 'rgba(245,197,66,.35)';
          ctx.lineWidth = 1.5;
          ctx.stroke();
        }
    }
  }

  // Hovered hex highlight
  if (hoveredHex) {
    const [cx, cy] = hexCenter(hoveredHex.r, hoveredHex.c);
    const pts = hexPath(cx, cy, size + 1);
    ctx.beginPath();
    ctx.moveTo(pts[0][0], pts[0][1]);
    for (let i = 1; i < 6; i++) ctx.lineTo(pts[i][0], pts[i][1]);
    ctx.closePath();
    ctx.strokeStyle = 'rgba(255,255,255,.35)';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  // Entities
  entities.forEach(e => {
    if (e.r === undefined) return;
    const key = `${e.r},${e.c}`;
    if (!visible.has(key) && e.type !== 'city') return;
    // Foreign stuff in fog: skip if not explored
    if (!explored.has(key)) return;
    // Foreign units only in visible
    if ((e.type === 'foreign' || e.type === 'barb') && !visible.has(key)) return;

    const [cx, cy] = hexCenter(e.r, e.c);

    if (e.type === 'city') {
      // City circle
      ctx.beginPath();
      ctx.arc(cx, cy, 16, 0, Math.PI * 2);
      ctx.fillStyle = e.civ === 'rome' ? '#8b0000' : '#c0a030';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.font = 'bold 10px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#fff';
      ctx.fillText(e.name, cx, cy - 20);
      ctx.font = '9px sans-serif';
      ctx.fillText('Pop ' + (e.pop||'?'), cx, cy + 4);
    } else {
      // Unit badge
      const isSelected = selectedEntity === e;
      const bgColor = e.type === 'barb' ? '#8b4513' : e.type === 'foreign' ? '#b8860b' : '#1a5276';
      ctx.beginPath();
      ctx.arc(cx, cy - 2, 13, 0, Math.PI * 2);
      ctx.fillStyle = bgColor;
      ctx.fill();
      if (isSelected) { ctx.strokeStyle = '#f5c542'; ctx.lineWidth = 2.5; }
      else { ctx.strokeStyle = 'rgba(255,255,255,.5)'; ctx.lineWidth = 1.5; }
      ctx.stroke();
      ctx.font = '14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(e.icon, cx, cy + 3);
      // HP bar
      if (e.hp > 0 && e.hpMax > 0 && e.hp < e.hpMax) {
        const bw = 20, bh = 3;
        ctx.fillStyle = '#333';
        ctx.fillRect(cx - bw/2, cy + 12, bw, bh);
        ctx.fillStyle = e.hp > 50 ? '#66bb6a' : e.hp > 25 ? '#ff9800' : '#e74c3c';
        ctx.fillRect(cx - bw/2, cy + 12, bw * e.hp / e.hpMax, bh);
      }
      // Name label
      ctx.font = '8px sans-serif';
      ctx.fillStyle = '#ccc';
      ctx.fillText(e.name, cx, cy + 22);
    }
  });

  ctx.restore();
  drawMinimap();
}

// â”€â”€ Minimap â”€â”€
function drawMinimap() {
  const mc = document.getElementById('minimap-canvas');
  const mctx = mc.getContext('2d');
  const scale = mc.width / mapW;
  mctx.clearRect(0, 0, mc.width, mc.height);
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const key = `${r},${c}`;
      if (!explored.has(key)) continue;
      const [hx, hy] = hexCenter(r, c);
      const meta = TERRAIN_META[map[r][c]];
      mctx.fillStyle = visible.has(key) ? meta.color : '#223';
      mctx.fillRect(hx * scale - 2, hy * scale - 2, 4, 4);
    }
  }
  // Units/cities
  entities.filter(e=>e.civ==='rome'||e.cls).forEach(e=>{
    const [hx,hy]=hexCenter(e.r,e.c);
    mctx.fillStyle = e.type==='city'?'#ff4444':'#ffcc00';
    mctx.fillRect(hx*scale-2,hy*scale-2, e.type==='city'?5:3, e.type==='city'?5:3);
  });
  // Viewport rect
  const vp = document.getElementById('minimap-viewport');
  const vw = canvas.width / 1 * scale;
  const vh = canvas.height / 1 * scale;
  vp.style.width = Math.min(vw, mc.width) + 'px';
  vp.style.height = Math.min(vh, mc.height) + 'px';
  vp.style.left = Math.max(0, -camX * scale) + 'px';
  vp.style.top = Math.max(0, -camY * scale) + 'px';
}

// â”€â”€ Mouse interaction â”€â”€
let isDragging = false, dragStartX, dragStartY, dragCamX, dragCamY, dragMoved;
const mapArea = document.getElementById('map-area');

mapArea.addEventListener('mousedown', e => {
  if (e.button !== 0) return;
  isDragging = true; dragMoved = false;
  dragStartX = e.clientX; dragStartY = e.clientY;
  dragCamX = camX; dragCamY = camY;
  mapArea.classList.add('dragging');
});
window.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left - camX;
  const my = e.clientY - rect.top - camY;

  if (isDragging) {
    const dx = e.clientX - dragStartX, dy = e.clientY - dragStartY;
    if (Math.abs(dx) + Math.abs(dy) > 4) dragMoved = true;
    camX = dragCamX + dx;
    camY = dragCamY + dy;
    drawMap();
    return;
  }

  // Hover
  const hex = pixelToHex(mx, my);
  if (hex && (hex.r !== hoveredHex?.r || hex.c !== hoveredHex?.c)) {
    hoveredHex = hex;
    drawMap();
    showTooltip(e.clientX, e.clientY, hex);
  } else if (!hex) {
    hoveredHex = null;
    document.getElementById('tile-tooltip').style.display = 'none';
    drawMap();
  } else {
    // Update tooltip position
    const tt = document.getElementById('tile-tooltip');
    tt.style.left = (e.clientX + 14) + 'px';
    tt.style.top = (e.clientY + 14) + 'px';
  }
});
window.addEventListener('mouseup', e => {
  if (isDragging && !dragMoved) {
    // Click on map
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left - camX;
    const my = e.clientY - rect.top - camY;
    const hex = pixelToHex(mx, my);
    if (hex) handleClick(hex);
  }
  isDragging = false;
  mapArea.classList.remove('dragging');
});

function showTooltip(mx, my, hex) {
  const tt = document.getElementById('tile-tooltip');
  const key = `${hex.r},${hex.c}`;
  if (!explored.has(key)) { tt.style.display = 'none'; return; }
  const terrain = map[hex.r][hex.c];
  const meta = TERRAIN_META[terrain];
  const res = resources[key];
  const ent = entities.find(e => e.r === hex.r && e.c === hex.c);
  const dist = districts.find(d => d.r === hex.r && d.c === hex.c);

  let html = `<div class="tt-title">${meta.name}${res ? ' â€” ' + RES_ICONS[res] + ' ' + res.charAt(0).toUpperCase() + res.slice(1) : ''}</div>`;
  if (dist) html += `<div style="font-size:.72rem;color:#ba68c8;">District: ${dist.type}</div>`;
  if (ent) html += `<div style="font-size:.72rem;color:#4fc3f7;">${ent.name}${ent.hp?' (HP: '+ent.hp+'/'+ent.hpMax+')':''}</div>`;
  html += `<div class="tt-yields">`;
  if (meta.food) html += `<span><span style="color:var(--food)">â—</span>${meta.food}F</span>`;
  if (meta.prod) html += `<span><span style="color:var(--prod)">â—</span>${meta.prod}P</span>`;
  if (meta.gold) html += `<span><span style="color:var(--gold)">â—</span>${meta.gold}G</span>`;
  html += `</div>`;

  tt.innerHTML = html;
  tt.style.display = 'block';
  tt.style.left = (mx + 14) + 'px';
  tt.style.top = (my + 14) + 'px';
}

function handleClick(hex) {
  const ent = entities.find(e => e.r === hex.r && e.c === hex.c && (e.cls || e.type === 'city'));
  if (ent) {
    selectedEntity = ent;
    showContext(ent);
  } else {
    selectedEntity = null;
    document.getElementById('context-panel').innerHTML = '<h3>No Selection</h3><p style="font-size:.8rem;color:var(--text-dim);">Click a unit or city on the map to see available actions.</p>';
  }
  drawMap();
}

// â”€â”€ Init â”€â”€
setTimeout(() => { resizeCanvas(); drawMap(); }, 50);


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTEXT ACTIONS (same as before)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const contextActions = {
  warrior:{title:'Warrior â€” Melee (CS 20, HP 85/100, MP 2/2)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'âš”ï¸',label:'Attack',p:1},{icon:'ğŸ›¡ï¸',label:'Fortify',p:0},{icon:'ğŸ›¡ï¸',label:'Fortify Until Healed',p:0},
    {icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'ğŸ”„',label:'Upgrade â†’ Swordsman',p:0},{icon:'â¬†ï¸',label:'Promote',p:0},
    {icon:'ğŸ¤',label:'Form Corps',p:0},{icon:'ğŸ¤',label:'Escort Formation',p:0},{icon:'ğŸ”¥',label:'Pillage',p:0},{icon:'âš¡',label:'Condemn Heretic',p:0},
    {icon:'ğŸš«',label:'Alert',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  archer:{title:'Archer â€” Ranged (CS 15, RS 25, Range 2, HP 100/100, MP 2/2)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'ğŸ¹',label:'Ranged Attack',p:1},{icon:'ğŸ›¡ï¸',label:'Fortify',p:0},{icon:'ğŸ›¡ï¸',label:'Fortify Until Healed',p:0},
    {icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'ğŸ”„',label:'Upgrade â†’ Crossbowman',p:0},{icon:'â¬†ï¸',label:'Promote',p:0},
    {icon:'ğŸ¤',label:'Form Corps',p:0},{icon:'ğŸ¤',label:'Escort Formation',p:0},{icon:'ğŸ”¥',label:'Pillage',p:0},{icon:'ğŸš«',label:'Alert',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  settler:{title:'Settler â€” Civilian (MP 2/2)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'ğŸ™ï¸',label:'Found City',p:1},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  builder:{title:'Builder â€” Civilian (Charges: 3, MP 2/2)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'ğŸŒ¾',label:'Build Farm',p:1},{icon:'â›ï¸',label:'Build Mine',p:0},{icon:'ğŸªµ',label:'Build Lumber Mill',p:0},
    {icon:'ğŸ£',label:'Build Fishing Boats',p:0},{icon:'ğŸ„',label:'Build Pasture',p:0},{icon:'ğŸŒ´',label:'Build Plantation',p:0},{icon:'â›º',label:'Build Camp',p:0},
    {icon:'ğŸª¨',label:'Build Quarry',p:0},{icon:'ğŸª“',label:'Harvest Resource',p:0},{icon:'ğŸŒ³',label:'Remove Woods',p:0},{icon:'ğŸŒ¿',label:'Remove Rainforest',p:0},
    {icon:'ğŸ’§',label:'Remove Marsh',p:0},{icon:'ğŸ”§',label:'Repair Improvement',p:0},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  scout:{title:'Scout â€” Recon (CS 10, MP 3/3)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'âš”ï¸',label:'Attack',p:1},{icon:'ğŸ›¡ï¸',label:'Fortify',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0},
    {icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'â¬†ï¸',label:'Promote',p:0},{icon:'ğŸ”„',label:'Upgrade â†’ Skirmisher',p:0},{icon:'ğŸš«',label:'Alert',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  trader:{title:'Trader â€” Civilian (MP 1/1)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'ğŸ“¦',label:'Establish Trade Route',p:1},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  missionary:{title:'Missionary â€” Religious (RS 100, Charges: 3, MP 4/4)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'âœï¸',label:'Spread Religion',p:1},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  apostle:{title:'Apostle â€” Religious (RS 110, Charges: 3, MP 4/4)',actions:[
    {icon:'ğŸš¶',label:'Move',p:0},{icon:'âœï¸',label:'Spread Religion',p:1},{icon:'âš¡',label:'Theological Combat',p:0},{icon:'ğŸ“¿',label:'Evangelize Belief',p:0},
    {icon:'ğŸ”±',label:'Launch Inquisition',p:0},{icon:'ğŸ˜´',label:'Sleep',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0},{icon:'âŒ',label:'Delete Unit',p:0}]},
  spy:{title:'Spy â€” Agent Viper (Level 2, MP 1/1)',actions:[
    {icon:'ğŸš¶',label:'Move to City',p:0},{icon:'ğŸ”',label:'Gain Sources',p:1},{icon:'âš—ï¸',label:'Steal Tech Boost',p:0},{icon:'ğŸ’°',label:'Siphon Funds',p:0},
    {icon:'ğŸ–¼ï¸',label:'Great Work Heist',p:0},{icon:'ğŸ”§',label:'Sabotage Production',p:0},{icon:'ğŸš€',label:'Disrupt Rocketry',p:0},
    {icon:'ğŸ—¡ï¸',label:'Recruit Partisans',p:0},{icon:'ğŸ›¡ï¸',label:'Counterspy',p:0},{icon:'â¸ï¸',label:'Skip Turn',p:0}]},
};
const cityActions = {title:'Rome â€” Pop: 7 | Housing: 8 | Amenities: Happy (+1)',actions:[
  {icon:'ğŸ—ï¸',label:'Build Unit',p:1},{icon:'ğŸ›ï¸',label:'Build Building',p:1},{icon:'ğŸ“',label:'Build District',p:1},{icon:'ğŸ—¿',label:'Build Wonder',p:0},
  {icon:'ğŸ“‹',label:'Run Project',p:0},{icon:'ğŸ’°',label:'Purchase (Gold)',p:0},{icon:'â›ª',label:'Purchase (Faith)',p:0},{icon:'ğŸ‘¥',label:'Manage Citizens',p:0},
  {icon:'ğŸ—ºï¸',label:'Buy Tile',p:0},{icon:'ğŸ°',label:'Walls & Defenses',p:0},{icon:'ğŸ”„',label:'Change Production',p:0},{icon:'ğŸ“Š',label:'City Details',p:0},
  {icon:'ğŸ™ï¸',label:'Rename City',p:0},{icon:'ğŸ”¥',label:'Raze City',p:0},{icon:'ğŸ•Šï¸',label:'Liberate City',p:0}]};

function showContext(ent) {
  let data;
  if (ent.type === 'city') {
    data = {...cityActions, title: `${ent.name} â€” Pop: ${ent.pop} | Housing: ${ent.pop+1} | Amenities: Happy (+1)`};
  } else {
    data = contextActions[ent.cls];
  }
  if (!data) { document.getElementById('context-panel').innerHTML = '<h3>'+ent.name+'</h3><p style="font-size:.8rem;color:var(--text-dim);">No actions available for this unit.</p>'; return; }
  const panel = document.getElementById('context-panel');
  panel.innerHTML = `<h3>${data.title}</h3><div class="action-grid">${data.actions.map(a =>
    `<button class="action-btn${a.p?' primary':''}" onclick="alert('Action: ${a.label}')"><span class="icon">${a.icon}</span> ${a.label}</button>`
  ).join('')}</div>`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR PANELS (unchanged content)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activePanel = null;
document.querySelectorAll('.sb-btn[data-panel]').forEach(btn => {
  btn.addEventListener('click', () => {
    const p = btn.dataset.panel;
    if (activePanel === p) { closePanel(); return; }
    openPanel(p);
  });
});
function openPanel(name) {
  activePanel = name;
  document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.sb-btn[data-panel="${name}"]`)?.classList.add('active');
  document.getElementById('right-panel').classList.add('open');
  document.getElementById('rp-title').textContent = panelTitles[name] || name;
  document.getElementById('rp-body').innerHTML = panelContent[name] || '<p>No content</p>';
  setTimeout(resizeCanvas, 50);
}
function closePanel() {
  activePanel = null;
  document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('right-panel').classList.remove('open');
  setTimeout(resizeCanvas, 50);
}

const panelTitles = {research:'Research â€” Technology',civics:'Civics',government:'Government & Policies',diplomacy:'Diplomacy',religion:'Religion',greatpeople:'Great People',trade:'Trade Routes',espionage:'Espionage',citystates:'City-States',rankings:'Rankings & Victory'};
const panelContent = {};

panelContent.research = `<div class="panel-section"><h4>Current Research</h4><div style="padding:10px 12px;background:rgba(79,195,247,.1);border:1px solid var(--science);border-radius:var(--radius);margin-bottom:10px;"><div style="font-weight:700;">Iron Working</div><div style="font-size:.72rem;color:var(--text-dim);margin-top:2px;">5 / 12 turns â€” 24 / 67 âš—ï¸</div><div style="height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:6px;"><div style="height:100%;width:36%;background:var(--science);border-radius:2px;"></div></div></div><h4>Available Technologies</h4><ul class="panel-list"><li><span class="icon">âš—ï¸</span> Mathematics <span class="meta">8 turns</span></li><li><span class="icon">âš—ï¸</span> Construction <span class="meta">10 turns</span></li><li><span class="icon">âš—ï¸</span> Engineering <span class="meta">12 turns</span></li><li><span class="icon">âš—ï¸</span> Horseback Riding <span class="meta">7 turns</span></li><li><span class="icon">âš—ï¸</span> Currency <span class="meta">9 turns</span></li><li><span class="icon">âš—ï¸</span> Shipbuilding <span class="meta">11 turns</span></li></ul></div><div class="panel-section"><h4>Eureka Boosts</h4><ul class="panel-list"><li>ğŸ¯ Mathematics â€” Build 3 specialty districts <span class="meta">2/3</span></li><li>ğŸ¯ Construction â€” Build a Water Mill <span class="meta">0/1</span></li><li>ğŸ¯ Horseback Riding â€” Build a Pasture <span class="meta">1/1 âœ“</span></li></ul></div>`;

panelContent.civics = `<div class="panel-section"><h4>Current Civic</h4><div style="padding:10px 12px;background:rgba(186,104,200,.1);border:1px solid var(--culture);border-radius:var(--radius);margin-bottom:10px;"><div style="font-weight:700;">Recorded History</div><div style="font-size:.72rem;color:var(--text-dim);margin-top:2px;">3 / 8 turns â€” 16 / 60 ğŸ­</div><div style="height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:6px;"><div style="height:100%;width:27%;background:var(--culture);border-radius:2px;"></div></div></div><h4>Available Civics</h4><ul class="panel-list"><li><span class="icon">ğŸ­</span> Drama and Poetry <span class="meta">6 turns</span></li><li><span class="icon">ğŸ­</span> Military Training <span class="meta">5 turns</span></li><li><span class="icon">ğŸ­</span> Defensive Tactics <span class="meta">7 turns</span></li><li><span class="icon">ğŸ­</span> Theology <span class="meta">9 turns</span></li><li><span class="icon">ğŸ­</span> Games and Recreation <span class="meta">6 turns</span></li></ul></div><div class="panel-section"><h4>Inspiration Boosts</h4><ul class="panel-list"><li>ğŸ¯ Drama and Poetry â€” Build a Wonder <span class="meta">0/1</span></li><li>ğŸ¯ Military Training â€” Build an Encampment <span class="meta">0/1</span></li><li>ğŸ¯ Theology â€” Earn a Great Prophet <span class="meta">0/1</span></li></ul></div>`;

panelContent.government = `<div class="panel-section"><h4>Current Government â€” Oligarchy</h4><div style="padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--radius);font-size:.8rem;margin-bottom:8px;"><div style="color:var(--gold);font-weight:600;">+4 Combat Strength for melee, anti-cavalry, and naval melee</div><div style="color:var(--text-dim);margin-top:4px;">Legacy: +1 Production per turn in Capital</div></div><button class="action-btn primary" onclick="alert('Change Government')">ğŸ›ï¸ Change Government</button></div><div class="panel-section"><h4>Policy Card Slots</h4><div class="policy-slots"><div class="policy-slot military" onclick="alert('Select Military policy')"><span class="slot-label" style="color:#e74c3c">ğŸ”´ Military:</span><span class="slot-card">Agoge (+50% Ancient/Classical melee & ranged)</span></div><div class="policy-slot economic" onclick="alert('Select Economic policy')"><span class="slot-label" style="color:#f1c40f">ğŸŸ¡ Economic:</span><span class="slot-card">Urban Planning (+1 Production all cities)</span></div><div class="policy-slot diplomatic" onclick="alert('Select Diplomatic policy')"><span class="slot-label" style="color:#2ecc71">ğŸŸ¢ Diplomatic:</span><span class="slot-card">Diplomatic League (+1 Envoy on meet)</span></div><div class="policy-slot wildcard" onclick="alert('Select Wildcard policy')"><span class="slot-label" style="color:#9b59b6">ğŸŸ£ Wildcard:</span><span class="slot-card">Revelation (+2 Great Prophet pts/turn)</span></div></div></div><div class="panel-section"><h4>Available Governments</h4><ul class="panel-list"><li><span class="icon">ğŸ‘‘</span> Autocracy <span class="meta">2M 1E 1W</span></li><li><span class="icon">ğŸ›ï¸</span> Classical Republic <span class="meta">1M 1E 1D 1W</span></li></ul></div>`;

panelContent.diplomacy = `<div class="panel-section"><h4>Known Civilizations</h4><div id="civ-list"><div class="civ-card" onclick="toggleDiploActions(this)"><div class="civ-avatar" style="background:#2c3e50;">ğŸ‡ªğŸ‡¬</div><div class="civ-info"><div class="name">Egypt</div><div class="leader">Cleopatra â€” Friendly</div></div></div><div class="diplo-actions" style="display:none;"><button class="action-btn">ğŸ“¨ Send Delegation</button><button class="action-btn">ğŸ¤ Declare Friendship</button><button class="action-btn">ğŸ›ï¸ Establish Embassy</button><button class="action-btn">ğŸ”“ Open Borders</button><button class="action-btn">ğŸ’° Propose Trade Deal</button><button class="action-btn">âš”ï¸ Surprise War</button><button class="action-btn">âš”ï¸ Formal War</button><button class="action-btn">ğŸ‘ Denounce</button><button class="action-btn">ğŸ“œ Alliance</button><button class="action-btn">ğŸ—¡ï¸ Joint War</button></div><div class="civ-card" onclick="toggleDiploActions(this)"><div class="civ-avatar" style="background:#1a5276;">ğŸ‡©ğŸ‡ª</div><div class="civ-info"><div class="name">Germany</div><div class="leader">Frederick â€” Unfriendly</div></div></div><div class="diplo-actions" style="display:none;"><button class="action-btn">ğŸ“¨ Send Delegation</button><button class="action-btn">ğŸ”“ Open Borders</button><button class="action-btn">ğŸ’° Trade Deal</button><button class="action-btn">âš”ï¸ Surprise War</button><button class="action-btn">âš”ï¸ Formal War</button><button class="action-btn">âš”ï¸ Holy War</button><button class="action-btn">âš”ï¸ Liberation War</button><button class="action-btn">âš”ï¸ Protectorate War</button><button class="action-btn">âš”ï¸ Colonial War</button><button class="action-btn">ğŸ‘ Denounce</button><button class="action-btn">ğŸ•Šï¸ Make Peace</button></div><div class="civ-card" onclick="toggleDiploActions(this)"><div class="civ-avatar" style="background:#6c3483;">ğŸ‡¬ğŸ‡·</div><div class="civ-info"><div class="name">Greece</div><div class="leader">Pericles â€” Neutral</div></div></div><div class="diplo-actions" style="display:none;"><button class="action-btn">ğŸ“¨ Send Delegation</button><button class="action-btn">ğŸ¤ Declare Friendship</button><button class="action-btn">ğŸ›ï¸ Embassy</button><button class="action-btn">ğŸ”“ Open Borders</button><button class="action-btn">ğŸ’° Trade Deal</button><button class="action-btn">âš”ï¸ Surprise War</button><button class="action-btn">âš”ï¸ Formal War</button><button class="action-btn">ğŸ‘ Denounce</button></div></div></div><div class="panel-section"><h4>Active Agreements</h4><ul class="panel-list"><li>ğŸ”“ Open Borders with Egypt <span class="meta">18 turns left</span></li><li>ğŸ“œ Alliance with Egypt <span class="meta">22 turns left</span></li></ul></div>`;

panelContent.religion = `<div class="panel-section"><h4>Your Religion â€” Catholicism</h4><div style="padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--radius);font-size:.8rem;margin-bottom:8px;"><div>ğŸ•Šï¸ <strong>Pantheon:</strong> God of the Forge (+25% military Production)</div><div>ğŸ›ï¸ <strong>Founder:</strong> Tithe (+1 Gold per 4 followers)</div><div>ğŸ™ <strong>Follower:</strong> Choral Music (Shrines/Temples give Culture = Faith)</div><div>ğŸ“¿ <strong>Enhancer:</strong> <em>â€” Not yet selected â€”</em></div><div>ğŸ—ï¸ <strong>Worship:</strong> <em>â€” Not yet selected â€”</em></div></div></div><div class="panel-section"><h4>Religious Actions</h4><div class="action-grid"><button class="action-btn" onclick="alert('Evangelize Belief')">ğŸ“¿ Evangelize Belief</button><button class="action-btn" onclick="alert('Launch Inquisition')">âš¡ Launch Inquisition</button><button class="action-btn" onclick="alert('Purchase Missionary')">âœï¸ Buy Missionary</button><button class="action-btn" onclick="alert('Purchase Apostle')">ğŸ™ Buy Apostle</button><button class="action-btn" onclick="alert('Purchase Inquisitor')">ğŸ”± Buy Inquisitor</button><button class="action-btn" onclick="alert('Purchase Guru')">ğŸ’š Buy Guru</button></div></div><div class="panel-section"><h4>Religious Spread</h4><ul class="panel-list"><li>ğŸ™ï¸ Rome â€” 8/10 followers <span class="meta">Majority âœ“</span></li><li>ğŸ™ï¸ Antium â€” 5/7 followers <span class="meta">Majority âœ“</span></li><li>ğŸ™ï¸ Cumae â€” 2/5 followers <span class="meta">Minority</span></li></ul></div>`;

panelContent.greatpeople = `<div class="panel-section"><h4>Available to Recruit</h4><ul class="panel-list"><li><span class="icon">ğŸ”¬</span><div><div style="font-weight:600;">Hypatia</div><div style="font-size:.7rem;color:var(--text-dim);">Great Scientist â€” Libraries +1 Science</div></div><span class="meta">60/120 GPP</span></li><li><span class="icon">âš™ï¸</span><div><div style="font-weight:600;">Isidore of Miletus</div><div style="font-size:.7rem;color:var(--text-dim);">Great Engineer â€” +215 Production toward Wonder</div></div><span class="meta">20/80 GPP</span></li><li><span class="icon">âš”ï¸</span><div><div style="font-weight:600;">Sun Tzu</div><div style="font-size:.7rem;color:var(--text-dim);">Great General â€” +5 CS and +1 MP in 2 tiles</div></div><span class="meta">45/60 GPP</span></li></ul></div><div class="panel-section"><h4>Actions</h4><div class="action-grid"><button class="action-btn" onclick="alert('Recruit')">â­ Recruit</button><button class="action-btn" onclick="alert('Patronize Gold')">ğŸ’° Patronize (Gold)</button><button class="action-btn" onclick="alert('Patronize Faith')">â›ª Patronize (Faith)</button><button class="action-btn" onclick="alert('Pass')">â­ï¸ Pass</button></div></div><div class="panel-section"><h4>Great Works</h4><ul class="panel-list"><li>ğŸ“– "The Republic" â€” Theater Square, Rome <span class="meta">+2C +2T</span></li><li>ğŸ–¼ï¸ "Starry Night" â€” Theater Square, Antium <span class="meta">+3C +3T</span></li></ul></div>`;

panelContent.trade = `<div class="panel-section"><h4>Active Trade Routes (2 / 3)</h4><ul class="panel-list"><li><span class="icon">ğŸ“¦</span><div><div style="font-weight:600;">Rome â†’ Thebes (Egypt)</div><div style="font-size:.7rem;color:var(--text-dim);">+3 Gold, +1 Science, +1 Culture</div></div><span class="meta">8 turns</span></li><li><span class="icon">ğŸ“¦</span><div><div style="font-weight:600;">Rome â†’ Antium (Domestic)</div><div style="font-size:.7rem;color:var(--text-dim);">+1 Food, +1 Production</div></div><span class="meta">4 turns</span></li></ul></div><div class="panel-section"><h4>Assign New Route</h4><ul class="panel-list"><li onclick="alert('Route to Athens')">ğŸ™ï¸ â†’ Athens (Greece) <span class="meta">+4G +1S</span></li><li onclick="alert('Route to Berlin')">ğŸ™ï¸ â†’ Berlin (Germany) <span class="meta">+3G +2C</span></li><li onclick="alert('Domestic to Cumae')">ğŸ  â†’ Cumae (Domestic) <span class="meta">+2F +2P</span></li></ul></div>`;

panelContent.espionage = `<div class="panel-section"><h4>Your Spies (1 / 2)</h4><ul class="panel-list"><li><span class="icon">ğŸ•µï¸</span><div><div style="font-weight:600;">Agent Viper â€” Level 2</div><div style="font-size:.7rem;color:var(--text-dim);">Thebes, Egypt â€” Gaining Sources</div></div><span class="meta">3 turns</span></li></ul></div><div class="panel-section"><h4>Available Missions</h4><ul class="panel-list"><li onclick="alert('Gain Sources')">ğŸ” Gain Sources <span class="meta">+1 Visibility</span></li><li onclick="alert('Steal Tech')">âš—ï¸ Steal Tech Boost <span class="meta">Campus</span></li><li onclick="alert('Siphon Funds')">ğŸ’° Siphon Funds <span class="meta">Commercial Hub</span></li><li onclick="alert('Great Work Heist')">ğŸ–¼ï¸ Great Work Heist <span class="meta">Theater Sq.</span></li><li onclick="alert('Sabotage')">ğŸ”§ Sabotage Production <span class="meta">Ind. Zone</span></li><li onclick="alert('Disrupt')">ğŸš€ Disrupt Rocketry <span class="meta">Spaceport</span></li><li onclick="alert('Partisans')">ğŸ—¡ï¸ Recruit Partisans <span class="meta">Neighborhood</span></li><li onclick="alert('Counterspy')">ğŸ›¡ï¸ Counterspy <span class="meta">Defend</span></li></ul></div>`;

panelContent.citystates = `<div class="panel-section"><h4>Known City-States</h4><ul class="panel-list"><li><span class="icon" style="color:var(--science);">ğŸ”µ</span><div><div style="font-weight:600;">Geneva (Scientific)</div><div style="font-size:.7rem;color:var(--text-dim);">Your Envoys: 3 â€” Suzerain âœ“</div></div><span class="meta">+15% Sci</span></li><li><span class="icon" style="color:#e74c3c;">ğŸ”´</span><div><div style="font-weight:600;">Kabul (Militaristic)</div><div style="font-size:.7rem;color:var(--text-dim);">Your Envoys: 1</div></div><span class="meta">+50% XP</span></li><li><span class="icon" style="color:#f1c40f;">ğŸŸ¡</span><div><div style="font-weight:600;">Zanzibar (Trade)</div><div style="font-size:.7rem;color:var(--text-dim);">Your Envoys: 0</div></div><span class="meta">â€”</span></li></ul></div><div class="panel-section"><h4>Actions</h4><div class="action-grid"><button class="action-btn" onclick="alert('Send Envoy')">ğŸ“¤ Send Envoy (2)</button><button class="action-btn" onclick="alert('Levy Military')">âš”ï¸ Levy Military</button><button class="action-btn" onclick="alert('View Quests')">ğŸ“‹ View Quests</button><button class="action-btn" onclick="alert('Declare War')">ğŸ—¡ï¸ Declare War</button></div></div>`;

panelContent.rankings = `<div class="panel-section"><h4>Victory Progress</h4><ul class="panel-list"><li>ğŸ”¬ <strong>Science</strong> <span class="meta">0/5 projects</span></li><li>ğŸ­ <strong>Culture</strong> <span class="meta">12% Tourism</span></li><li>âš”ï¸ <strong>Domination</strong> <span class="meta">1/4 capitals</span></li><li>â›ª <strong>Religious</strong> <span class="meta">1/4 civs</span></li><li>ğŸ“Š <strong>Score</strong> <span class="meta">285</span></li></ul></div><div class="panel-section"><h4>Rankings</h4><ul class="panel-list"><li>ğŸ¥‡ Rome (You) <span class="meta">285</span></li><li>ğŸ¥ˆ Egypt <span class="meta">260</span></li><li>ğŸ¥‰ Greece <span class="meta">240</span></li><li>4. Germany <span class="meta">215</span></li></ul></div>`;

function toggleDiploActions(el) {
  const a = el.nextElementSibling;
  if (a?.classList.contains('diplo-actions')) a.style.display = a.style.display === 'none' ? 'flex' : 'none';
}

// â”€â”€ End Turn â”€â”€
let currentTurn = 42;
function endTurn() {
  currentTurn++;
  document.querySelector('#turn-info .turn').textContent = `Turn ${currentTurn}`;
  document.querySelector('#end-turn-btn .sub').textContent = `Turn ${currentTurn} â†’ ${currentTurn + 1}`;
  selectedEntity = null;
  document.getElementById('context-panel').innerHTML = '<h3>No Selection</h3><p style="font-size:.8rem;color:var(--text-dim);">Click a unit or city on the map to see available actions.</p>';
  document.getElementById('notifications').innerHTML = `<div class="notif">ğŸ”„ Turn ${currentTurn} â€” All units refreshed</div><div class="notif">ğŸ—ï¸ Rome completed Granary â€” choose next production</div>`;
  drawMap();
}
</script>
</body>
</html>
